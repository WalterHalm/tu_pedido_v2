<odoo>
  <template id="portal_order_estado_pedido" inherit_id="sale.sale_order_portal_template">
    <xpath expr="//div[@id='portal_sale_content']" position="inside">
      <div class="card mt-3" t-if="sale_order.estado_rapido">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Estado de tu Pedido</h5>
        </div>
        <div class="card-body">
          <div t-if="sale_order.tiempo_estimado_entrega > 0" class="alert alert-info text-center mb-3">
            <strong>Tiempo estimado: <t t-esc="sale_order.tiempo_estimado_entrega"/> minutos</strong>
          </div>
          
          <div class="mb-3">
            <t t-set="progreso" t-value="{'nuevo': 15, 'aceptado': 30, 'preparacion': 60, 'terminado': 80, 'despachado': 95, 'entregado': 100, 'rechazado': 0}.get(sale_order.estado_rapido, 0)"/>
            <div class="progress" style="height: 25px;">
              <div class="progress-bar bg-success" t-attf-style="width: {{progreso}}%">
                <strong><t t-esc="progreso"/>%</strong>
              </div>
            </div>
          </div>
          
          <div class="alert alert-info text-center">
            <h5>
              <t t-if="sale_order.estado_rapido == 'nuevo'">Tu pedido ha sido recibido</t>
              <t t-elif="sale_order.estado_rapido == 'aceptado'">Tu pedido ha sido confirmado</t>
              <t t-elif="sale_order.estado_rapido == 'preparacion'">Estamos preparando tu pedido</t>
              <t t-elif="sale_order.estado_rapido == 'terminado'">Tu pedido esta listo</t>
              <t t-elif="sale_order.estado_rapido == 'despachado'">Tu pedido ha sido despachado</t>
              <t t-elif="sale_order.estado_rapido == 'entregado'">Pedido entregado</t>
              <t t-elif="sale_order.estado_rapido == 'rechazado'">Pedido rechazado</t>
            </h5>
            <p t-if="sale_order.estado_rapido != 'entregado'">Tiempo: <strong><t t-esc="sale_order.tiempo_total_minutos"/> min</strong></p>
            <div t-if="sale_order.estado_rapido == 'rechazado' and sale_order.motivo_rechazo" class="alert alert-danger mt-2">
              <strong>Motivo del rechazo:</strong> <t t-esc="sale_order.motivo_rechazo"/>
            </div>
          </div>
          
          <div t-if="sale_order.estado_rapido == 'despachado' and not sale_order.cliente_confirmo_recepcion" class="text-center">
            <button class="btn btn-success mr-2" t-attf-onclick="confirmarRecepcion({{sale_order.id}})">
              Confirmar Recepcion
            </button>
            <button class="btn btn-warning" t-attf-onclick="generarReclamo({{sale_order.id}})">
              No me llego - Generar Reclamo
            </button>
          </div>
          
          <div t-if="sale_order.nota_cocina" class="mt-3">
            <strong>Notas:</strong> <t t-esc="sale_order.nota_cocina"/>
          </div>
        </div>
      </div>
      
      <script>
        function confirmarRecepcion(orderId) {
          if (confirm('Confirmas que recibiste tu pedido?')) {
            fetch('/tu_pedido/confirmar_recepcion/' + orderId, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({})
            }).then(response => response.json()).then(data => {
              if (data.success) {
                alert('Gracias!');
                location.reload();
              }
            });
          }
        }
        
        function generarReclamo(orderId) {
          const motivo = prompt('Describe el motivo del reclamo:');
          if (motivo) {
            fetch('/tu_pedido/generar_reclamo/' + orderId, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({motivo: motivo})
            }).then(response => response.json()).then(data => {
              if (data.success) {
                alert('Reclamo generado exitosamente');
                location.reload();
              }
            });
          }
        }
        
        setInterval(function() { location.reload(); }, 30000);
      </script>
    </xpath>
  </template>
</odoo>